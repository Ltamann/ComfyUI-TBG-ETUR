"""
_______________________________________________________________________________________________________________________________________________
______________________________________TBG_Enhanced Tiled Upscaler and Refiner FLUX PRO_________________________________________________________
__________________________________________________a ToBi´s Generations production_____________________________________________________________________

TBG_Enhanced Tiled Upscaler and Refiner FLUX PRO
Nodes:
TBG_Enhanced Tiled Upscaler FLUX PRO
TBG_Enhanced Refiner FLUX PRO

⚈ TBG Tile Enrichment Pipe
⚈ TBG Tile Prompt Pipe
⚈ TBG Tile ControlNet Pipe

Next-Level Upscaler & Segment Detailer with FLUX FILL Differential Diffusion, Reflux Style Transfer,
Custom Denoise per Frame, High-Res ControlNet per Tile, and Added Enhancement Tools.

Unlock the power of ultra-precise image enhancement with TBG_Flux Optimized Refiner Pro.
Featuring cutting-edge upscaling, segment detailing,
differential diffusion, and style transfer, this tool offers custom per-frame denoise,
high-res ControlNet per tile, and normalized image quality for unmatched
control over detail and clarity. Perfect for high-end refinement and upscaling tasks with FLUX.

Inspired by and Based on ComfyUI_MaraScott_Nodes McBoaty v5 by MaraScott (Discord: davask#4370), originally copyrighted in 2024 by David Asquiedge (davask).
Modifications made by TBG______, all modifications copyrighted in 2025 by TBG______.


Enhancements Added:

    Dual CLIP support via Flux
    Flux guidance integration for tiles
    General prompt application across all tiles
    ControlNet support for upscaling and tile-specific ControlNets
    Custom Sigma input functionality
    Separate inputs for image width and height
    Detail Daemon support for tile enhancement
    Lifted tile number limit (from 64 to unlimited)
    Removed max image size cap (previously 8096px)
    Finer detail rendering using interior upscale/downscale and sample enlargement
    Added Flux Fill with different diffusion models under inpaint conditioning
        (Note: Inpaint blurred border falls within blend area, which may retain input image noise)
    Reflux style model now applied per tile (verify correct tile index selection)
    Mask to Segment support added for detailling Objects during Tile Refinment — manual or automatic edge detection
    Tile-level latent upscaling + denoiser injection + 2-pass KSampler


To Be Added Soon or not:
    croped conditions for full tile cnet - at this moment all is only tile based

    TBG_Upscale and Refiner Preset Node
    Simple Upscaler with Creative and Strict Modes
    Creativity settings including reassembly, fractality, engine behavior

    Other Improvements:
    More Per-tile customization: Denoise, Redux Strength, ControlNet Strength, and Flux Prompt Guidance
    Preview comparison after processing each tile in the same node
    CNet start/end timings linked to Sigma rest noise for consistent settings regardless of curve

Additional Enhancements Under Review:
    Controlled noise addition via ControlNet (link to example) https://note-com.translate.goog/mitsukinozomi/n/ne51e2138a0f0?_x_tr_sl=auto&_x_tr_tl=en&_x_tr_hl=es&_x_tr_pto=wapp&_x_tr_hist=true
    Sigma adjustments like softening/sharpening and extra detail sampling



____TBG_Flux Enhanced Tiled Upscaler and Refiner PRO ______________________________________________________________________________

bugs- there is a problem with tile size calculation if optimized tile size is chosen so that the add feather mask is not working i saw a tile with smaller  side length
bugs - solved, segments dont render in 1 Tile preview
solved, rainbow/noisy borders. when images are not multiples of 64 - but also if there are
Mejora:  Original Tile size is overlapping the last tile to compensate the differences - should it be better to distribute the overlaying to all tiles and add more context reference inpaint boarder to each image

bug - upscaler is not working in denoising mode
bug the inpainting of the segments is not satisfying  . maybe thera are not upscaled and the bolder ist not from generated tiles
____version alfa 1.2 _____________________________________________________________________________________________________________
- API integration for Por and Community Edition CE
- Renaming and Node Structuring

____version alfa 1.1 _____________________________________________________________________________________________________________
- added segment generation with generated tile background
- bug: not a real bug but the segments on high denoise are not really good integrated - sometimes segments are upscaled to much and inpaint gausian area is to small
- new segmenter tile, now square tiles witch grow mask, blur mask, inpaintmask -  surrounding from generated tiles. Upscale reduced to max x3 because more did produce visible differences in image details
____version alfa 1.00 _____________________________________________________________________________________________________________
going in production
- Inpaint border creation is now optimize to a to tile approach - and a blend mask is added to all different possibilities with a controller in the UI
- added janus-pro llm / need on off switch
- added model unload for janus-pro and redux  / need on off switch
- add rectified flow inversion / Noise inversion
- fixed bug segment 0
- inner tile upscale for getting all details set in 2 modes finer details (less disturbing up and downscale for fidelity), finer details + grain removal (upscale and downscale so fine details are lost)
____version alfa 0.09 _____________________________________________________________________________________________________________
Separating Notes in Pro and Simpel nodes
Added presets to the notes for simplification
More test for finding the best settings and more debug images
Solved problem with full image edges errors - sometimes the inpaint can produce broken edge - one way is to pad and crop the fullimages - the other to add 2-4 pixes of o very light mask to the border.
Added new Solution for Blurry Inpaint Solved unsharp and stuck flux images by adding to all borders always 2-5 pixel of 90% trasnparent mask - until now it solfed the problem of blurry flux resultes
Added a more efficient way the to add already generated tiles tile borders for inpaint to the next latent. Also i added a  4 pixel gradient mask to the overlapping corners to solve some lines or color changes in these areas
Many corrections on the tiler and on the rebuilder to get smoother inpaint borders.
add_last_generated_to_base_image
Added a different seed for each tile by adding index number to seed
____version alfa 0.08 _____________________________________________________________________________________________________________
Added better Tile calculation and tile mask builder - inpaint only is no working without compositing feathermask / solved in alfa 0.09
Added better border inpainting from generated tiles and segments preserver
____version alfa 0.07 _____________________________________________________________________________________________________________
Added Solution for Blurry Inpaint eta has to be higher so that flux dont get suck / added a different way in alfa 0.09
____version alfa 0.06 _____________________________________________________________________________________________________________
Added tile memorize if tiler is not changed.
Added Tile Preview to see what’s going on.
Added Shift to Mask to move the inpaint in and out of the tile border.
Repaired wrong inpaint mask and compositing mask script.
Added Optimize Tile size
Added Segment Upscale to MP and keep aspect ratio

____version alfa 0.05 _____________________________________________________________________________________________________________
Added Tiled_Fusion_Mode — an option for rebuilding tiles for inpainting before the next tile is sampled, with color correction.
Moved all inputs not needed by the Tiler to the Refiner.

____version alfa 0.04 _____________________________________________________________________________________________________________
Reorganized nodes and file structure; cleaned up a bit.
Added support for maintaining tiles while rendering one by one.
Added background change option from original to alternative.
Added support for SD, SDXL, and SD3.
Separated Differential Diffusion from the model with an on/off switch.

____version alfa 0.03 _____________________________________________________________________________________________________________
added Fast one Tile sampling
tried to add preview in same node by changing return to yield but not working
added save sampled tiles in temp folder for review during sampling
added different denoise calculators
        default:        cuts the lowsteps of totalseps by the factor of denoise and interpolates tham back to totalsteps
        defauld short:  cuts the lowsteps of totalseps by the factor of denoise, results in les teps than totalsteps
        multiplied:     multiplies Sigmas by the factor of denoise.  To use when aplienen combi split step sigma curves wher normal denoise is cutting the curves so splitstepcombis are broken this is only multiplying and keeping all steps.
        multiplied normalized: multiplies Sigmas by the factor of denoise where denoise = restnoise
        normalized advanced: looks for the nearest value where denoise value = restnoise value and cuts the curve on this point and interpolates tham back to totalsteps - the result will denoise in the exact same curve shape as in a full sampling starting by restnoise = denoise.
____version alfa 0.02 _____________________________________________________________________________________________________________

____version alfa 0.01 _____________________________________________________________________________________________________________




Presettings

Tiler:
Magnific Inpaint settings
Differential Diffusion
1024x1024
compositing mask 64
inpaint mask 64
shift -32
overlap_inpaint 256
Refinere
Generate Tiled Boarder
Momory off
Denoise Normalized 0.8

"""